#!/usr/bin/env python3

import math
import os
import sys
import logging
import secrets
from mcp.server import FastMCP
from fastapi import HTTPException, Request, Depends
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from fastapi.middleware.cors import CORSMiddleware

# Configure detailed logging for full terminal output
logging.basicConfig(
    level=logging.DEBUG,  # Changed from INFO to DEBUG for more detail
    format='%(asctime)s - %(name)s - %(levelname)s - %(funcName)s:%(lineno)d - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout)
    ]
)

# Set specific loggers to DEBUG for detailed output
logging.getLogger('bankofanthos').setLevel(logging.DEBUG)
logging.getLogger('bankofanthos_mcp_server').setLevel(logging.DEBUG)
logging.getLogger('mcp').setLevel(logging.DEBUG)  # Add MCP library logging
logging.getLogger('uvicorn').setLevel(logging.DEBUG)  # Add HTTP server logging

# Reduce noise from some libraries
logging.getLogger('httpx').setLevel(logging.WARNING)
logging.getLogger('aiohttp').setLevel(logging.WARNING)

logger = logging.getLogger(__name__)
logger.info("Starting Bank of Anthos MCP Server with full logging enabled")

# Load environment variables from .env file
try:
    from dotenv import load_dotenv
    env_path = os.path.join(os.path.dirname(__file__), '..', '.env')
    load_dotenv(env_path)
    logger.info(f"Loaded environment variables from {env_path}")
except ImportError:
    logger.warning("python-dotenv not available, environment variables may not be loaded")

# Generate or load API key for SSE authentication
API_KEY = os.getenv('BANKOFANTHOS_MCP_API_KEY') or secrets.token_urlsafe(32)
if not os.getenv('BANKOFANTHOS_MCP_API_KEY'):
    logger.warning(f"Generated new Bank of Anthos MCP API key: {API_KEY[:10]}...")
    logger.warning("Set BANKOFANTHOS_MCP_API_KEY environment variable for persistent key")

# Import our Bank of Anthos manager
from bankofanthos_managers import bankofanthos_manager

# Create MCP server
mcp = FastMCP("Bank of Anthos MCP Server")

# For SSE transport, we'll create a separate FastAPI app
from fastapi import FastAPI

sse_app = FastAPI(title="Bank of Anthos MCP Server", version="1.0.0")

# Add CORS middleware
sse_app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Configure appropriately for production
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Authentication
security = HTTPBearer()

async def verify_api_key(credentials: HTTPAuthorizationCredentials = Depends(security)):
    """Verify API key for SSE requests"""
    if credentials.credentials != API_KEY:
        raise HTTPException(status_code=401, detail="Invalid API key")
    return credentials

# USER AUTHENTICATION AND MANAGEMENT TOOLS

@mcp.tool()
async def authenticate_user(username: str, password: str) -> str:
    """Autentisera anvÃ¤ndare med anvÃ¤ndarnamn och lÃ¶senord"""
    success, result = bankofanthos_manager.authenticate_user(username, password)

    if success:
        return f"""âœ… **Inloggning Lyckades!**

ğŸ‘¤ AnvÃ¤ndare: `{username}`
ğŸ” Token: `{result[:20]}...`

âš ï¸ **VIKTIGT:** Spara denna token sÃ¤kert fÃ¶r framtida API-anrop!"""
    else:
        return f"âŒ Inloggning misslyckades: {result}"

@mcp.tool()
async def signup_user(username: str, password: str, firstname: str = "", lastname: str = "") -> str:
    """Skapa ett nytt anvÃ¤ndarkonto"""
    user_data = {}
    if firstname:
        user_data['firstname'] = firstname
    if lastname:
        user_data['lastname'] = lastname

    success, result = bankofanthos_manager.signup_user(username, password, **user_data)

    if success:
        return f"""âœ… **AnvÃ¤ndarkonto Skapad!**

ğŸ‘¤ AnvÃ¤ndarnamn: `{username}`
ğŸ“ Namn: {firstname} {lastname}

Du kan nu logga in med dina uppgifter."""
    else:
        return f"âŒ Konto skapande misslyckades: {result}"

@mcp.tool()
async def validate_token(token: str) -> str:
    """Validera JWT-token och visa anvÃ¤ndaruppgifter"""
    is_valid, claims = bankofanthos_manager.validate_token(token)

    if is_valid and claims:
        return f"""âœ… **Token Ã¤r Giltig**

ğŸ‘¤ AnvÃ¤ndare: `{claims.get('user', 'unknown')}`
ğŸ¦ Konto-ID: `{claims.get('acct', 'unknown')}`
ğŸ“… Skapad: {claims.get('iat', 'unknown')}
ğŸ“… Giltig till: {claims.get('exp', 'unknown')}"""
    else:
        return "âŒ Token Ã¤r ogiltig eller har gÃ¥tt ut"

# ACCOUNT MANAGEMENT TOOLS

@mcp.tool()
async def get_account_balance(account_id: str, token: str) -> str:
    """Visa saldo fÃ¶r ett bankkonto"""
    success, result = bankofanthos_manager.get_account_balance(account_id, token)

    if success:
        try:
            import json
            balance_data = json.loads(result)

            # Format the balance (assuming it's in cents)
            balance_cents = balance_data.get('balance', 0)
            balance_dollars = balance_cents / 100

            return f"""ğŸ’° **Konto Saldo**

ğŸ¦ Konto-ID: `{account_id}`
ğŸ’µ Saldo: ${balance_dollars:,.2f} USD

ğŸ“Š Raw Data: {result}"""
        except json.JSONDecodeError:
            return f"ğŸ’° **Konto Saldo**\n\nğŸ¦ Konto-ID: `{account_id}`\nğŸ“Š Data: {result}"
    else:
        return f"âŒ Saldo hÃ¤mtning misslyckades: {result}"

@mcp.tool()
async def get_transaction_history(account_id: str, token: str) -> str:
    """Visa transaktionshistorik fÃ¶r ett konto"""
    success, result = bankofanthos_manager.get_transaction_history(account_id, token)

    if success:
        try:
            import json
            transactions = json.loads(result)

            if not transactions:
                return f"ğŸ“‹ **Transaktionshistorik**\n\nğŸ¦ Konto-ID: `{account_id}`\nğŸ“ Inga transaktioner hittades"

            message = f"ğŸ“‹ **Transaktionshistorik fÃ¶r Konto {account_id}**\n\n"

            for i, tx in enumerate(transactions[:10], 1):  # Show last 10 transactions
                amount_cents = tx.get('amount', 0)
                amount_dollars = abs(amount_cents) / 100
                direction = "â¡ï¸" if amount_cents > 0 else "â¬…ï¸"

                message += f"{i}. {direction} ${amount_dollars:,.2f} USD\n"
                message += f"   Till: {tx.get('toAccountNum', 'N/A')}\n"
                message += f"   FrÃ¥n: {tx.get('fromAccountNum', 'N/A')}\n"
                message += f"   Datum: {tx.get('timestamp', 'N/A')}\n\n"

            if len(transactions) > 10:
                message += f"... och {len(transactions) - 10} till transaktioner"

            return message

        except json.JSONDecodeError:
            return f"ğŸ“‹ **Transaktionshistorik**\n\nğŸ“Š Data: {result}"
    else:
        return f"âŒ Transaktionshistorik hÃ¤mtning misslyckades: {result}"

# TRANSACTION TOOLS

@mcp.tool()
async def execute_fiat_transfer(from_account: str, to_account: str, amount_usd: float, token: str, uuid: str = None) -> str:
    """UtfÃ¶r en fiat-Ã¶verfÃ¶ring mellan konton"""
    if uuid is None:
        import uuid
        uuid = str(uuid.uuid4())

    transfer_data = {
        'fromAccountNum': from_account,
        'fromRoutingNum': bankofanthos_manager.local_routing,
        'toAccountNum': to_account,
        'toRoutingNum': bankofanthos_manager.local_routing,
        'amount': amount_usd,
        'uuid': uuid
    }

    success, result = bankofanthos_manager.execute_fiat_transfer(transfer_data, token)

    if success:
        return f"""âœ… **Ã–verfÃ¶ring UtfÃ¶rd!**

â¬…ï¸ FrÃ¥n konto: `{from_account}`
â¡ï¸ Till konto: `{to_account}`
ğŸ’µ Belopp: ${amount_usd:,.2f} USD
ğŸ†” Transaktion-ID: `{uuid}`

âœ… {result}"""
    else:
        return f"âŒ Ã–verfÃ¶ring misslyckades: {result}"

@mcp.tool()
async def execute_deposit(from_external_account: str, from_routing: str, to_account: str, amount_usd: float, token: str, uuid: str = None) -> str:
    """UtfÃ¶r en insÃ¤ttning frÃ¥n externt konto"""
    if uuid is None:
        import uuid
        uuid = str(uuid.uuid4())

    deposit_data = {
        'fromAccountNum': from_external_account,
        'fromRoutingNum': from_routing,
        'toAccountNum': to_account,
        'amount': amount_usd,
        'uuid': uuid
    }

    success, result = bankofanthos_manager.execute_deposit(deposit_data, token)

    if success:
        return f"""âœ… **InsÃ¤ttning UtfÃ¶rd!**

ğŸ¦ Externt konto: `{from_external_account}` (Routing: `{from_routing}`)
â¡ï¸ Till konto: `{to_account}`
ğŸ’µ Belopp: ${amount_usd:,.2f} USD
ğŸ†” Transaktion-ID: `{uuid}`

âœ… {result}"""
    else:
        return f"âŒ InsÃ¤ttning misslyckades: {result}"

@mcp.tool()
async def execute_payment(to_account: str, amount_usd: float, token: str, contact_label: str = None, uuid: str = None) -> str:
    """UtfÃ¶r en betalning (anvÃ¤ndarvÃ¤nlig wrapper runt execute_fiat_transfer)"""
    # First get user info from token to get account ID
    is_valid, claims = bankofanthos_manager.validate_token(token)
    if not is_valid or not claims:
        return "âŒ Ogiltig token - vÃ¤nligen logga in igen"

    from_account = claims.get('acct')
    if not from_account:
        return "âŒ Kunde inte hÃ¤mta kontoinformation frÃ¥n token"

    if uuid is None:
        import uuid
        uuid = str(uuid.uuid4())

    transfer_data = {
        'fromAccountNum': from_account,
        'fromRoutingNum': bankofanthos_manager.local_routing,
        'toAccountNum': to_account,
        'toRoutingNum': bankofanthos_manager.local_routing,
        'amount': amount_usd,
        'uuid': uuid
    }

    success, result = bankofanthos_manager.execute_fiat_transfer(transfer_data, token)

    if success:
        contact_info = f" (Kontakt: {contact_label})" if contact_label else ""
        return f"""âœ… **Betalning UtfÃ¶rd!**

ğŸ‘¤ FrÃ¥n ditt konto: `{from_account}`
â¡ï¸ Till: `{to_account}`{contact_info}
ğŸ’µ Belopp: ${amount_usd:,.2f} USD
ğŸ†” Transaktion-ID: `{uuid}`

âœ… {result}"""
    else:
        return f"âŒ Betalning misslyckades: {result}"

# CONTACTS MANAGEMENT TOOLS

@mcp.tool()
async def get_contacts(token: str) -> str:
    """Visa anvÃ¤ndarens kontaktlista"""
    # Get username from token
    is_valid, claims = bankofanthos_manager.validate_token(token)
    if not is_valid or not claims:
        return "âŒ Ogiltig token - vÃ¤nligen logga in igen"

    username = claims.get('user')
    if not username:
        return "âŒ Kunde inte hÃ¤mta anvÃ¤ndarinformation frÃ¥n token"

    success, result = bankofanthos_manager.get_contacts(username, token)

    if success:
        try:
            import json
            contacts = json.loads(result)

            if not contacts:
                return "ğŸ“ **Kontaktlista**\n\nğŸ“ Du har inga kontakter sparade Ã¤n"

            message = "ğŸ“ **Dina Kontakter**\n\n"

            for i, contact in enumerate(contacts, 1):
                message += f"{i}. **{contact.get('label', 'Unnamed')}**\n"
                message += f"   ğŸ¦ Konto: `{contact.get('account_num', 'N/A')}`\n"
                message += f"   ğŸ›ï¸  Routing: `{contact.get('routing_num', 'N/A')}`\n"
                message += f"   ğŸŒ Extern: {'Ja' if contact.get('is_external') else 'Nej'}\n\n"

            return message

        except json.JSONDecodeError:
            return f"ğŸ“ **Kontaktlista**\n\nğŸ“Š Data: {result}"
    else:
        return f"âŒ Kontaktlista hÃ¤mtning misslyckades: {result}"

@mcp.tool()
async def add_contact(label: str, account_num: str, routing_num: str, is_external: bool, token: str) -> str:
    """LÃ¤gg till en ny kontakt"""
    # Get username from token
    is_valid, claims = bankofanthos_manager.validate_token(token)
    if not is_valid or not claims:
        return "âŒ Ogiltig token - vÃ¤nligen logga in igen"

    username = claims.get('user')
    if not username:
        return "âŒ Kunde inte hÃ¤mta anvÃ¤ndarinformation frÃ¥n token"

    contact_data = {
        'label': label,
        'account_num': account_num,
        'routing_num': routing_num,
        'is_external': is_external
    }

    success, result = bankofanthos_manager.add_contact(username, contact_data, token)

    if success:
        contact_type = "extern" if is_external else "intern"
        return f"""âœ… **Kontakt Tillagd!**

ğŸ‘¤ Namn: **{label}**
ğŸ¦ Konto: `{account_num}`
ğŸ›ï¸  Routing: `{routing_num}`
ğŸŒ Typ: {contact_type.title()}

Du kan nu anvÃ¤nda denna kontakt fÃ¶r betalningar."""
    else:
        return f"âŒ Kontakt tillÃ¤gg misslyckades: {result}"

@mcp.tool()
async def add_external_contact(label: str, account_num: str, routing_num: str, token: str) -> str:
    """LÃ¤gg till en extern kontakt (anvÃ¤ndarvÃ¤nlig wrapper)"""
    return await add_contact(label, account_num, routing_num, True, token)

@mcp.tool()
async def add_internal_contact(label: str, account_num: str, token: str) -> str:
    """LÃ¤gg till en intern Bank of Anthos-kontakt (anvÃ¤ndarvÃ¤nlig wrapper)"""
    return await add_contact(label, account_num, bankofanthos_manager.local_routing, False, token)

# RESOURCES

@mcp.resource("greeting://{name}")
def get_greeting(name: str) -> str:
    """Get a personalized greeting"""
    return f"Hej {name}! VÃ¤lkommen till Bank of Anthos MCP Server!"

@mcp.resource("help://info")
def get_help() -> str:
    """Get help information"""
    return """
ğŸ› ï¸ **Bank of Anthos MCP Server Verktyg:**

**Autentisering & AnvÃ¤ndarhantering:**
- authenticate_user: Logga in med anvÃ¤ndarnamn/lÃ¶senord
- signup_user: Skapa nytt anvÃ¤ndarkonto
- validate_token: Kontrollera JWT-token

**Kontohantering:**
- get_account_balance: Visa kontosaldo
- get_transaction_history: Visa transaktionshistorik

**Transaktioner:**
- execute_fiat_transfer: Ã–verfÃ¶r pengar mellan konton
- execute_deposit: SÃ¤tt in pengar frÃ¥n externt konto
- execute_payment: Betala till kontakt (anvÃ¤ndarvÃ¤nligt)

**Kontakter:**
- get_contacts: Visa kontaktlista
- add_contact: LÃ¤gg till ny kontakt
- add_external_contact: LÃ¤gg till extern kontakt
- add_internal_contact: LÃ¤gg till intern kontakt

**Konfiguration:**
- Alla verktyg krÃ¤ver giltig JWT-token (fÃ¶rutom authenticate_user)
- Belopp anges i USD (konverteras automatiskt till cents)
- Konto-ID:n och routing-nummer mÃ¥ste vara giltiga

**AnvÃ¤ndning:**
Servern mÃ¶jliggÃ¶r komplett integration mellan traditionell bank och DeFi genom AI-agenter.

**SÃ¤kerhet:**
- AnvÃ¤nd endast giltiga JWT-tokens
- Verifiera alla transaktioner fÃ¶re genomfÃ¶rande
- Alla Ã¶verfÃ¶ringar krÃ¤ver explicit bekrÃ¤ftelse
"""


@mcp.resource("status://services")
def get_service_status() -> str:
    """Get status of all Bank of Anthos services"""
    services = {
        'userservice': bankofanthos_manager.userservice_uri,
        'balances': bankofanthos_manager.balances_uri,
        'transactions': bankofanthos_manager.transactions_uri,
        'history': bankofanthos_manager.history_uri,
        'contacts': bankofanthos_manager.contacts_uri
    }

    status_report = "ğŸ” **Bank of Anthos Service Status**\n\n"
    for service_name, url in services.items():
        # Simple connectivity check (would need actual health endpoints in production)
        status_report += f"âœ… {service_name}: {url}\n"

    status_report += f"\nğŸ›ï¸ Local Routing: {bankofanthos_manager.local_routing}\n"
    status_report += f"â±ï¸ Timeout: {bankofanthos_manager.backend_timeout}s\n"
    status_report += f"ğŸ” Token Validation: {'Available' if bankofanthos_manager.public_key else 'Not Available'}\n"

    return status_report


# Start server
if __name__ == "__main__":
    import sys

    # Determine transport mode - prioritize environment variable, then command line arg
    transport_mode = os.getenv('BANKOFANTHOS_MCP_TRANSPORT', 'stdio')  # Default to stdio for backward compatibility

    # Check command line arguments
    if len(sys.argv) > 1:
        if sys.argv[1] == "--sse":
            transport_mode = "sse"
        elif sys.argv[1] == "--stdio":
            transport_mode = "stdio"

    logger.info(f"ğŸš€ Bank of Anthos MCP Server Starting")
    logger.info(f"ğŸ“¡ Transport Mode: {transport_mode}")
    logger.info(f"ğŸ”‘ API Key Available: {bool(API_KEY)}")

    if transport_mode == "sse":
        # SSE mode for remote access
        port = int(os.getenv('BANKOFANTHOS_MCP_PORT', '8001'))  # Different port from crypto server
        host = os.getenv('BANKOFANTHOS_MCP_HOST', 'localhost')

        logger.info(f"ğŸŒ SSE Configuration:")
        logger.info(f"   ğŸ“ Host: {host}")
        logger.info(f"   ğŸ”Œ Port: {port}")
        logger.info(f"   ğŸ›¤ï¸  Endpoint: http://{host}:{port}/sse")
        logger.info(f"   ğŸ” API Key: {API_KEY[:16]}..." if API_KEY else "None")
        logger.info(f"ğŸ“‹ Environment Variables:")
        logger.info(f"   BANKOFANTHOS_MCP_TRANSPORT: {transport_mode}")
        logger.info(f"   BANKOFANTHOS_MCP_HOST: {host}")
        logger.info(f"   BANKOFANTHOS_MCP_PORT: {port}")

        # Log all available tools
        logger.info("ğŸ› ï¸  Available Tools:")
        tool_names = [
            "authenticate_user", "signup_user", "validate_token",
            "get_account_balance", "get_transaction_history",
            "execute_fiat_transfer", "execute_deposit", "execute_payment",
            "get_contacts", "add_contact", "add_external_contact", "add_internal_contact"
        ]
        for tool_name in tool_names:
            logger.info(f"   âœ… {tool_name}")

        logger.info("ğŸ¯ Starting SSE server...")

        # Run MCP with SSE transport
        mcp.run(transport="sse")

    elif transport_mode == "stdio":
        # Default stdio mode for local MCP clients
        logger.info("ğŸ”Œ STDIO Configuration:")
        logger.info("   ğŸ“ Communication: stdin/stdout")
        logger.info("   ğŸ¯ Target: Local MCP clients")
        logger.info("   ğŸ’¡ Use --sse flag for remote access")

        # Log all available tools
        logger.info("ğŸ› ï¸  Available Tools:")
        tool_names = [
            "authenticate_user", "signup_user", "validate_token",
            "get_account_balance", "get_transaction_history",
            "execute_fiat_transfer", "execute_deposit", "execute_payment",
            "get_contacts", "add_contact", "add_external_contact", "add_internal_contact"
        ]
        for tool_name in tool_names:
            logger.info(f"   âœ… {tool_name}")

        logger.info("ğŸ¯ Starting STDIO server...")

        mcp.run(transport="stdio")

    else:
        logger.error(f"âŒ Unknown transport mode: {transport_mode}")
        logger.info("ğŸ’¡ Supported modes: 'stdio' (default), 'sse', or use --sse/--stdio flags")
        sys.exit(1)